<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>Chootie Choo</title>

  <!-- Reset CSS -->
  <link rel="stylesheet" type="text/css" href="assets/css/reset.css">

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- moment.js -->
  <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <!-- Bootstrap CDN-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <!-- Google Fonts-->
  <link href="https://fonts.googleapis.com/css?family=Faster+One|IBM+Plex+Mono|Work+Sans" rel="stylesheet">

  <!-- Firebase Reference -->
  <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-database.js"></script>

  <style>
      .bigText {
          font-size: 80px;
          font-family: 'Work Sans', sans-serif;
          color: white;
          padding-bottom: 100px;
          
      }
      .special {
        margin: 300px;
      }

      .lead {
          color: white;
      }

      .jumbotron {
          background-image: url("assets/images/trainStation.jpg");
          background-position: center;
          background-size: contain;
          background-repeat:no-repeat;
          background-color: black;
          
      }

      td {
          text-align:left;
      }

      .tableHeader {
        font-family: 'Faster One', cursive;
      }

      body {
        font-family: 'Work Sans', sans-serif;
      }

    
      

  </style>

</head>
<body>
    <div class="jumbotron jumbotron-fluid text-center">
        <div class="container special">
            <h1 class = "bigText pb-0 mb-0">Chootie Choo</h1>
            <p class="lead">It goes on and on and on</p>
        </div>
    </div>
    <div class = "container">
    <table class="table border border-secondary table-striped rounded" id = "trainTable">
        <h1 class = "text-center tableHeader">Current Train Schedule</h1>
            <thead class = "thead-dark">
              <tr>
                <th scope="col">Train Name</th>
                <th scope="col">Destination</th>
                <th scope="col" class="text-center">Frequency (min)</th>
                <th scope="col" class="text-center">Next Arrival</th>
                <th scope="col" class="text-center">Minutes Away</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <h2 class = "text-center mt-5">New train submissions:</h2>
          <form class = "mt-1 bg-dark text-white">
                <div class="form-group">
                    <label for="trainNameInput">Train Name</label>
                    <input type="text" class="form-control border border-danger" id="trainNameInput">
                </div>
                <div class="form-group">
                        <label for="destinationInput">Destination</label>
                        <input type="text" class="form-control border border-danger" id="destinationInput">
                </div>
                <div class="form-group">
                        <label for="trainTimeInput">First Train Time (HH:mm)</label>
                        <input type="time" class="form-control border border-danger" id="trainTimeInput">
                </div>
                <div class="form-group">
                        <label for="frequencyInput">Frequency (min)</label>
                        <input type="number" class="form-control border border-danger" id="frequencyInput">
                </div>

                <button type="submit" class="btn btn-danger btn-block" id="submit-train">Submit</button>
              </form>
            </div>
    <script>
        // display ID's: 
        // input ID's: #trainNameInput, #destinationInput, #trainTimeInput, #frequencyInput

        var config = {
            apiKey: "AIzaSyBTXjLEK2jIcYDuPGLYwMR3-lkOAj5Nuls",
            authDomain: "train-time-fe0eb.firebaseapp.com",
            databaseURL: "https://train-time-fe0eb.firebaseio.com",
            projectId: "train-time-fe0eb",
            storageBucket: "",
            messagingSenderId: "219768034060"
        };
        firebase.initializeApp(config);

        // for referencing the database
        var database = firebase.database();


        $("#submit-train").on("click", function(event) {
            event.preventDefault();
            var trainName = $("#trainNameInput").val().trim();
            console.log("Train name: " + trainName);
            var destination = $("#destinationInput").val().trim();
            console.log("The destination is: " + destination);
            var firstStopTime = $("#trainTimeInput").val().trim();
            console.log("The first train arrives at: " + firstStopTime);
            var frequency = $("#frequencyInput").val().trim();
            console.log("It runs every " + frequency + " minutes.");

            var newTrain = {
                name: trainName,
                destination: destination,
                firstTime: firstStopTime,
                frequency: frequency,
                dateAdded: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref().push(newTrain);

            console.log(newTrain.name);
            console.log(newTrain.destination);
            console.log(newTrain.firstTime);
            console.log(newTrain.frequency);

            $("#trainNameInput").val("");
            $("#destinationInput").val("");
            $("#trainTimeInput").val("");
            $("#frequencyInput").val("");
        });

        database.ref().on("child_added", function(childSnapshot) {
            console.log(childSnapshot.val());

            var trainName = childSnapshot.val().name;
            var destination = childSnapshot.val().destination;
            var firstStopTime = childSnapshot.val().firstTime;
            var frequency = childSnapshot.val().frequency;

            console.log(trainName);
            console.log(destination);
            console.log(firstStopTime);
            console.log(frequency);

            var firstTimeFormatted = moment(firstStopTime, "HH:mm").subtract(1, "years");
            console.log(firstTimeFormatted);

            var currentTime = moment();
            console.log("the current time is: " + moment(currentTime).format("HH:mm"));

            var diffTime = moment().diff(moment(firstTimeFormatted), "minutes");
            console.log("The difference in time is: " + diffTime);

            var tRemainder = diffTime % frequency;
            console.log(tRemainder);

            var minutesLeft = frequency - tRemainder;
            console.log("Minutes left until the train is here: " + minutesLeft + "minutes");

            var nextTrain = moment().add(minutesLeft, "minutes").format("h:mm A");
            console.log("Arriving at: " + nextTrain);

            $("#trainTable > tbody").append("<tr><td>" + trainName + "</td><td>" + destination + "</td><td class='text-center'>" +
            frequency + "</td><td class='text-center'>" + nextTrain + "</td><td class='text-center'>" + minutesLeft + "</td></tr>");
        });
    // use moment(nextscheduledtraintime).toNow()); to calculate time remaining until now
    // firstStopTime + frequency = nextStopTime.  if nextStopTime has already passed, + frequency again.  else, Next Arrival and then calculate time left until now
    </script>
</body>
</html>